<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üìä Analizador HCN</title>
  <style>
    body { background: #121212; color: #f0f0f0; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
    h1 { color: #bb86fc; text-align: center; }
    .main-container { display: flex; flex-wrap: wrap; gap: 20px; }
    .panel { flex: 1; min-width: 300px; background: #1e1e1e; border-radius: 12px; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
    .sim-panel { order: -1; }
    textarea { width: 100%; height: 150px; background: #292929; color: #fff; border: none; border-radius: 8px; padding: 10px; resize: vertical; font-family: monospace; }
    .controls button {
      background: linear-gradient(to right, #bb86fc, #9a68cb);
      color: #000; border: none; padding: 10px 16px;
      border-radius: 8px; margin: 5px 5px 10px 0;
      cursor: pointer; font-weight: bold; transition: 0.3s;
    }
    .controls button:hover { transform: scale(1.05); box-shadow: 0 0 10px #bb86fc; }
    pre span.ok { color: #a0f8a0; }
    pre span.error { color: #ff5252; }
    svg { width: 100%; height: 300px; background: #000; border: 1px solid #444; }
    .stats { background: #1e1e1e; padding: 10px; margin-top: 10px; border-radius: 10px; color: #ccc; font-weight: bold; text-align: center; }
    .table-container { margin-top: 20px; background: #1e1e1e; border-radius: 12px; padding: 10px; display: none; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; border-bottom: 1px solid #444; }
    th { color: #bb86fc; text-align: left; }
    .toggle-btn { background: #444; color: #fff; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 20px; }
    .toggle-btn:hover { background: #666; }
  </style>
</head>
<body>
<h1>üìä Analizador de C√≥digo G/M HCN (Mejorado)</h1>

<div class="main-container">
  <div class="panel sim-panel">
    <h3>üé• Simulaci√≥n X-Z</h3>
    <svg id="simulador" viewBox="0 0 500 300">
      <line x1="250" y1="0" x2="250" y2="300" stroke="#555" stroke-dasharray="4"/>
      <line x1="0" y1="150" x2="500" y2="150" stroke="#555" stroke-dasharray="4"/>
    </svg>
    <div class="controls">
      <button onclick="simular()">‚ñ∂Ô∏è Reproducir</button>
      <button onclick="paso()">‚è≠Ô∏è Paso</button>
      <button onclick="reiniciar()">üîÅ Reiniciar</button>
    </div>
  </div>

  <div class="panel">
    <h3>üßæ Pega tu c√≥digo CNC</h3>
    <textarea id="codigo" placeholder="Ej: G00 X0 Z0\nG01 X10 Z-10 F150\nG71 ..."></textarea>
    <div class="controls">
      <button onclick="analizar()">üîç Analizar</button>
      <button onclick="copiar()">üìã Copiar</button>
    </div>
    <pre id="resultado"></pre>
    <div id="stats" class="stats"></div>
  </div>
</div>

<button class="toggle-btn" onclick="toggleTabla()">üìò Mostrar / Ocultar C√≥digos HCN</button>
<div id="tabla" class="table-container">
  <table>
    <tr><th>C√≥digo</th><th>Descripci√≥n</th></tr>
    <tr><td>G70</td><td>Acabado con perfil</td></tr>
    <tr><td>G71</td><td>Desbaste longitudinal</td></tr>
    <tr><td>G72</td><td>Desbaste transversal</td></tr>
    <tr><td>G73</td><td>Desbaste eficiencia</td></tr>
    <tr><td>G74</td><td>Ranurado frontal</td></tr>
    <tr><td>G75</td><td>Ranurado radial</td></tr>
    <tr><td>G76</td><td>Ciclo de roscado multipasadas</td></tr>
    <tr><td>G80‚ÄìG89</td><td>Ciclos de taladrado, mandrinado</td></tr>
    <tr><td>M03</td><td>Encender husillo</td></tr>
    <tr><td>M05</td><td>Parar husillo</td></tr>
    <tr><td>M08</td><td>Refrigerante ON</td></tr>
    <tr><td>M09</td><td>Refrigerante OFF</td></tr>
    <tr><td>M30</td><td>Fin de programa</td></tr>
  </table>
</div>

<script>
let lineas = [], index = 0, x = 250, z = 150, svg, simulando = false;

function toggleTabla() {
  const tabla = document.getElementById("tabla");
  tabla.style.display = tabla.style.display === "none" ? "block" : "none";
}

function analizar() {
  const codigo = document.getElementById("codigo").value.trim().split("\\n");
  lineas = codigo.filter(l => l.trim());
  let salida = '', ok = 0, err = 0;
  for (let i = 0; i < lineas.length; i++) {
    let l = lineas[i].toUpperCase().trim();
    let exp = '';
    if (!l) { exp = '‚ùå L√≠nea vac√≠a'; err++; }
    else if (l.includes("G70")) exp = "Acabado con perfil";
    else if (l.includes("G71")) exp = "Desbaste longitudinal";
    else if (l.includes("G72")) exp = "Desbaste transversal";
    else if (l.includes("G73")) exp = "Desbaste eficiencia";
    else if (l.includes("G74")) exp = "Ranurado frontal";
    else if (l.includes("G75")) exp = "Ranurado radial";
    else if (l.includes("G76")) exp = "Roscar multipasadas";
    else if (l.match(/G8[0-9]/)) exp = "Ciclo de taladrado/roscado";
    else if (l.includes("G00")) exp = "Movimiento r√°pido";
    else if (l.includes("G01")) exp = "Movimiento lineal";
    else if (l.includes("M03")) exp = "Husillo CW";
    else if (l.includes("M05")) exp = "Parar husillo";
    else if (l.includes("M08")) exp = "Refrigerante ON";
    else if (l.includes("M09")) exp = "Refrigerante OFF";
    else if (l.includes("M30")) exp = "Fin de programa";
    else if (l.match(/X|Z/)) exp = "Movimiento en eje";
    else exp = '‚ùå C√≥digo no reconocido', err++;
    if (!exp.startsWith('‚ùå')) ok++;
    salida += `<span class="${exp.startsWith('‚ùå') ? 'error':'ok'}">L√≠nea ${i+1}: ${l} ‚Üí ${exp}</span>\\n`;
  }
  document.getElementById("resultado").innerHTML = salida;
  document.getElementById("stats").innerText = `üìÑ Total: ${lineas.length} | ‚úÖ Correctas: ${ok} | ‚ùå Errores: ${err}`;
  reiniciar();
}

function copiar() {
  navigator.clipboard.writeText(document.getElementById("resultado").innerText).then(() => alert("Copiado al portapapeles"));
}

function simular() {
  if (simulando || lineas.length === 0) return;
  simulando = true; index = 0;
  simularPaso();
}

function simularPaso() {
  if (index >= lineas.length) { simulando = false; return; }
  ejecutar(lineas[index]);
  index++;
  setTimeout(simularPaso, 500);
}

function paso() {
  if (lineas.length === 0 || index >= lineas.length) return;
  ejecutar(lineas[index++]);
}

function reiniciar() {
  svg = document.getElementById("simulador");
  svg.innerHTML = '<line x1="250" y1="0" x2="250" y2="300" stroke="#555" stroke-dasharray="4"/><line x1="0" y1="150" x2="500" y2="150" stroke="#555" stroke-dasharray="4"/>';
  x = 250; z = 150; index = 0; simulando = false;
  let punto = document.createElementNS("http://www.w3.org/2000/svg", "circle");
  punto.setAttribute("cx", x); punto.setAttribute("cy", z); punto.setAttribute("r", 4); punto.setAttribute("fill", "#0f0");
  svg.appendChild(punto);
}

function ejecutar(l) {
  l = l.toUpperCase();
  if (!(l.includes("G00") || l.includes("G01"))) return;
  let X = l.match(/X(-?\\d+(\\.\\d+)?)/);
  let Z = l.match(/Z(-?\\d+(\\.\\d+)?)/);
  let newX = X ? 250 + parseFloat(X[1]) : x;
  let newZ = Z ? 150 - parseFloat(Z[1]) : z;
  let linea = document.createElementNS("http://www.w3.org/2000/svg", "line");
  linea.setAttribute("x1", x); linea.setAttribute("y1", z);
  linea.setAttribute("x2", newX); linea.setAttribute("y2", newZ);
  linea.setAttribute("stroke", "#bb86fc"); linea.setAttribute("stroke-width", "2");
  svg.appendChild(linea);
  x = newX; z = newZ;
}
</script>
</body>
</html>
